import unittest
import sys
import numpy as np
import torch
from torchvision import transforms, datasets
from PIL import Image

sys.path.insert(0, '../')
from utils import data_loader

class TestDataLoader(unittest.TestCase):
    def setUp(self):
        self.cityscapes_path = '../cityscapes'
        self.imagenet_path = '../tinyimagenet'
        self.image = Image.fromarray(np.uint8(np.random.randint(0,256,(32,32))))


    def test_input_image_transform(self):
        # Test with no resizing
        transform = data_loader.input_image_transform(0)
        image_tensor = transform(self.image)
        self.assertIsInstance(transform, transforms.Compose)
        self.assertIsInstance(image_tensor, torch.Tensor)
        self.assertEqual(image_tensor.size(), torch.Size([1,32,32]))

        # Test with resizing to 16x16
        transform = data_loader.input_image_transform(16)
        image_tensor = transform(self.image)
        self.assertIsInstance(transform, transforms.Compose)
        self.assertIsInstance(image_tensor, torch.Tensor)
        self.assertEqual(image_tensor.size(), torch.Size([1,16,16]))


    def test_output_image_transform(self):
        # Test with no resizing
        transform = data_loader.output_image_transform(0)
        image_tensor = transform(self.image)
        self.assertIsInstance(transform, transforms.Compose)
        self.assertIsInstance(image_tensor, torch.Tensor)
        self.assertEqual(image_tensor.size(), torch.Size([32,32]))

        # Test with resizing to 16x16
        transform = data_loader.output_image_transform(16)
        image_tensor = transform(self.image)
        self.assertIsInstance(transform, transforms.Compose)
        self.assertIsInstance(image_tensor, torch.Tensor)
        self.assertEqual(image_tensor.size(), torch.Size([16,16]))


    def test_load_data(self):
        # Test loading of cityscapes dataset, no resize
        data = data_loader.load_data(self.cityscapes_path, resize=False)
        sample_img, sample_label = data[0]
        self.assertIsInstance(data, datasets.Cityscapes)
        self.assertEqual(sample_img.size(), torch.Size([3,1024,2048]))
        self.assertEqual(sample_label.size(), torch.Size([1024,2048]))

        # Test loading of cityscapes dataset, resizing data to 256x256
        data = data_loader.load_data(self.cityscapes_path, resize=True)
        sample_img, sample_label = data[0]
        self.assertIsInstance(data, datasets.Cityscapes)
        self.assertEqual(sample_img.size(), torch.Size([3,256,256]))
        self.assertEqual(sample_label.size(), torch.Size([256,256]))

        # Test loading of tinyimagenet dataset, no resize
        #data = data_loader.load_data(self.imagenet_path, resize=False)
        #sample_img, sample_label = data[0]
        #self.assertIsInstance(data, datasets.ImageFolder)
        #self.assertEqual(sample_img.size(), torch.Size([3,1024,2048]))
        #self.assertEqual(sample_label.size(), torch.Size([1024,2048]))

        # Test loading of tinyimagenet dataset, resizing data to 256x256
        #data = data_loader.load_data(self.imagenet_path, resize=True)
        #sample_img, sample_label = data[0]
        #self.assertIsInstance(data, datasets.ImageFolder)
        #self.assertEqual(sample_img.size(), torch.Size([3,256,256]))
        #self.assertEqual(sample_label.size(), torch.Size([256,256]))



if __name__ == '__main__':
    unittest.main()
